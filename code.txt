This code is edited in nb branch.
